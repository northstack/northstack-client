FROM northstack:latest

RUN apk add \
        curl \
        jq \
        rsync \
        docker \
        bash \
        py-pip \
        mysql-client \
        shadow \
    && curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar \
        && chmod +x wp-cli.phar \
        && mv wp-cli.phar /usr/local/bin/wp \
    && pip install docker-compose \
    && docker-php-ext-install \
        mysqli \
        pdo_mysql

ARG NORTHSTACK_USER
ARG NORTHSTACK_UID
ARG NORTHSTACK_GROUP
ARG NORTHSTACK_GID
ARG DOCKER_GROUP

RUN set -u && \
    if getent group "$NORTHSTACK_GID" > /dev/null; then \
        grp=$(getent group "$NORTHSTACK_GID" | cut -d: -f 1); \
        groupdel -f "$grp"; \
    fi \
    && groupadd \
        --force \
        --gid "$NORTHSTACK_GID" \
        "$NORTHSTACK_GROUP" \
    && useradd \
        --uid "$NORTHSTACK_UID" \
        --no-create-home \
        --key MAIL_DIR=/tmp \
        --gid "$NORTHSTACK_GID" \
        --groups "$DOCKER_GROUP" \
        "$NORTHSTACK_USER"

ENTRYPOINT ["/bin/sh", "-c"]
